/**
 * 문장 품질 평가기 (ProseQualityAnalyzer) v1.0
 *
 * 생성된 텍스트의 문장 수준 품질을 평가하고 개선 지침 생성
 * - 클리셰 감지 및 대체어 제안
 * - 반복 표현 감지
 * - 설명적 서술(telling) 감지
 * - 문장 리듬/길이 분석
 * - 어미 반복 감지
 * - 감각 묘사 밀도 분석
 * - 한국어 소설 특화 금지 패턴
 */

// ============================================
// 품질 분석 결과
// ============================================

export interface ProseQualityReport {
  overallScore: number;        // 0-100
  sentenceScore: number;       // 문장 품질 점수
  rhythmScore: number;         // 리듬 점수
  sensoryScore: number;        // 감각 묘사 점수
  showDontTellScore: number;   // 보여주기 점수
  originalityScore: number;    // 독창성 점수

  issues: ProseIssue[];
  strengths: string[];
  improvementAreas: string[];
}

export interface ProseIssue {
  type: ProseIssueType;
  severity: 'critical' | 'warning' | 'info';
  location: string;
  description: string;
  suggestion: string;
}

export type ProseIssueType =
  | 'cliche'
  | 'repetition'
  | 'telling'
  | 'filter-word'
  | 'weak-verb'
  | 'adverb-abuse'
  | 'passive-voice'
  | 'rhythm-monotone'
  | 'ending-repetition'
  | 'sensory-lacking'
  | 'info-dump'
  | 'purple-prose'
  | 'dialogue-tag-repetition'
  | 'redundant-description';

// ============================================
// 문장 품질 평가기 클래스
// ============================================

export class ProseQualityAnalyzer {

  /**
   * 씬 작성 프롬프트에 포함할 문장 품질 가이드
   */
  generateQualityGuide(): string {
    return `
---
## 문장 품질 기준 (출판 수준)

### 금지 패턴 (절대 사용 금지)

#### 1. 필터 단어 (직접 감각으로 교체)
| 금지 | 교체 방법 |
|------|-----------|
| "~을 느꼈다" | 신체 반응으로 직접 묘사 |
| "~라고 생각했다" | 내면 독백 또는 행동으로 |
| "~이 보였다" | 직접 묘사 ("X가 있었다" → "X가 눈에 들어왔다") |
| "~인 것 같았다" | 확정적 표현으로 |
| "~을 알 수 있었다" | 직접 서술 |

#### 2. 감정 직접 명명 금지
| 금지 | 교체 방법 |
|------|-----------|
| "슬펐다" | "목구멍이 조여왔다" |
| "기뻤다" | "입꼬리가 저절로 올라갔다" |
| "화가 났다" | "주먹이 하얗게 질렸다" |
| "무서웠다" | "등줄기에 찬 것이 흘렀다" |
| "놀랐다" | "숨이 멎었다" |
| "걱정됐다" | "손톱이 손바닥을 팠다" |
| "긴장됐다" | "어깨가 귀까지 올라갔다" |
| "외로웠다" | "방이 너무 넓었다. 그의 숨소리만이 벽을 채웠다" |

#### 3. 클리셰 표현 금지 (독창적 표현으로 대체)
| 금지 클리셰 | 대체 방향 |
|-------------|-----------|
| "눈물이 뚝뚝" | 시야 변화, 목구멍 감각 |
| "가슴이 먹먹" | 명치 압박, 호흡 변화 |
| "심장이 쿵쾅" | 맥박의 구체적 위치 |
| "머리가 하얘졌다" | 사고 단절의 구체적 묘사 |
| "온몸에 소름" | 특정 부위의 반응 |
| "시간이 멈춘 듯" | 지각 변화의 구체적 묘사 |
| "입술을 꾹 깨물었다" | 다른 긴장 표현 |
| "눈빛이 흔들렸다" | 구체적 눈 움직임 |
| "고개를 끄덕였다" | 다른 동의 표현과 교대 사용 |
| "한숨을 내쉬었다" | 호흡 변화의 변형 |

#### 4. 약한 동사 (구체적 동사로 교체)
| 약한 동사 | 교체 예시 |
|-----------|-----------|
| "갔다" | 걸어갔다, 뛰어갔다, 성큼거렸다, 비틀거렸다 |
| "있었다" | 서 있었다, 앉아 있었다, 웅크리고 있었다 |
| "했다" | 구체적 행동 동사 |
| "봤다" | 응시했다, 훑었다, 쏘아보았다 |
| "말했다" | 속삭였다, 내뱉었다, 읊조렸다, 외쳤다 |

#### 5. 어미 반복 금지
- 같은 어미(-다, -였다, -ㄴ다)가 4문장 연속 불가
- 변형 패턴: -다 / -았다 / -ㄹ까 / -는 / 대사 / 짧은 문장
- 문장 길이도 변형: 긴-중-짧-긴 등

### 필수 적용 기법

#### 1. 감각 레이어링 (매 단락 최소 2감각)
각 단락에 시각 외 최소 1가지 감각을 포함:
- **청각**: 소리, 침묵, 반향, 바스락, 윙윙
- **촉각**: 온도, 질감, 압력, 바람, 습기
- **후각**: 흙냄새, 피냄새, 꽃향기, 먼지, 연기
- **미각**: 쓴맛, 피맛, 달콤함 (비유적 포함)
- **고유감각**: 어지러움, 균형 상실, 무거움, 가벼움

#### 2. 문장 리듬 패턴
- **긴장 고조**: 문장을 점점 짧게
  "칼이 번뜩였다. 피가 튀었다. 끝이었다."
- **여유/성찰**: 문장을 길게, 수식어 풍부하게
- **충격**: 긴 문장 후 한 단어/한 문장으로 끊기
  "그가 오랫동안 기다려온 사람이 마침내 문 앞에 서 있었다. 죽은 줄 알았던 아버지가."
- **시간 정지**: 현재형 전환 + 감각 나열

#### 3. 대사 서술 다양화
- "~라고 말했다"는 전체 대사의 20% 이하
- 대체 패턴:
  * 행동 + 대사: "검을 들며 말했다" → "검을 뽑았다. '지금이다.'"
  * 대사만: 들여쓰기로 화자 구분
  * 반응 + 대사: "눈이 커졌다. '정말?'"
  * 대사 + 내면: "'그래.' 하지만 속으로는 달랐다."
  * 환경 + 대사: "바람이 불었다. '떠나자.'"

#### 4. 시작과 끝
- **시작**: 감각/행동/대화 중 하나 (배경설명 시작 금지)
  * ✅ "칼끝에서 핏물이 떨어졌다."
  * ✅ "'여기가 어디지?'"
  * ❌ "그날은 비가 오는 날이었다." (진부한 날씨 시작)
- **끝**: 여운/이미지/질문 (요약 끝 금지)
  * ✅ "문이 닫혔다. 빈 방에 그의 향기만 남았다."
  * ❌ "그렇게 그날은 끝이 났다." (요약식 마무리)

#### 5. 정보 전달 규칙
- 3문장 이상 연속 설명 금지 (행동/대사 사이에 끼워넣기)
- 배경 설명은 캐릭터의 감각/인식을 통해 전달
  * ❌ "이 마을은 300년 전에 세워졌다. 인구는 500명이다."
  * ✅ "낡은 성벽의 이끼를 훑으며 걸었다. 선조 때부터 세 세대가 이 마을을 지켰다."
- 역사/배경 정보는 캐릭터의 대화나 회상 속에 자연스럽게
`;
  }

  /**
   * 텍스트 분석 프롬프트 (AI에게 분석을 요청할 때)
   */
  generateAnalysisPrompt(text: string): string {
    return `## 문장 품질 분석

아래 소설 텍스트를 분석하고 JSON으로 평가 결과를 반환하세요:

### 평가 항목
1. **클리셰 수** (적을수록 좋음)
2. **필터 단어 수** ("느꼈다", "생각했다" 등)
3. **감정 직접 명명 수** ("슬펐다", "화가 났다" 등)
4. **감각 묘사 종류 수** (시각/청각/촉각/후각/미각 중 사용된 것)
5. **어미 반복**: 같은 어미 4연속 횟수
6. **대사 서술태그 반복**: "말했다" 연속 사용 횟수
7. **보여주기 비율**: 전체 감정 표현 중 신체반응으로 묘사된 비율

### 텍스트:
${text}

### 응답 형식 (JSON):
{
  "overallScore": 0-100,
  "clicheCount": number,
  "filterWordCount": number,
  "emotionNamingCount": number,
  "sensoryTypes": number,
  "endingRepetitions": number,
  "dialogueTagRepetitions": number,
  "showRatio": 0-100,
  "issues": [
    {
      "type": "cliche|filter-word|telling|repetition",
      "text": "문제가 되는 텍스트",
      "suggestion": "개선 방향"
    }
  ],
  "strengths": ["잘한 점 목록"]
}`;
  }
}

export default ProseQualityAnalyzer;
