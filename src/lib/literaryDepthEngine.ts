/**
 * 문학적 깊이 엔진 (LiteraryDepthEngine) v1.0
 *
 * 세계 최고 수준의 문학 기법을 AI에 주입
 * - 은유/직유 생성 가이드
 * - 상징 체계 관리
 * - 극적 아이러니 설계
 * - 서브텍스트 레이어 구축
 * - 다층적 의미 구조
 * - 여백과 생략의 기법
 * - 시점 조작 기법
 * - 시간 조작 기법
 */

// ============================================
// 문학적 장치 타입 정의
// ============================================

export interface SymbolSystem {
  symbol: string;              // 상징 대상 (예: "비", "달", "칼")
  surfaceMeaning: string;       // 표면적 의미
  deepMeaning: string;          // 심층적 의미
  characterConnection: string;  // 캐릭터와의 연관
  evolution: string;            // 소설 진행에 따른 의미 변화
  appearances: {
    sceneNumber: number;
    context: string;
    meaningAtThisPoint: string;
  }[];
}

export interface DramaticIrony {
  id: string;
  description: string;
  whatReaderKnows: string;       // 독자가 아는 것
  whatCharacterKnows: string;    // 캐릭터가 아는 것
  tensionSource: string;         // 긴장의 원천
  payoffScene: number;           // 해소되는 씬
  intensityLevel: 1 | 2 | 3 | 4 | 5;
}

export interface SubtextLayer {
  surfaceAction: string;         // 표면적 행동
  hiddenMeaning: string;         // 숨겨진 의미
  characterAwareness: 'aware' | 'unaware' | 'partially-aware';
  readerClue: string;            // 독자가 알아챌 단서
}

export type MetaphorType =
  | 'visual'          // 시각적 은유
  | 'kinesthetic'     // 운동감각 은유
  | 'natural'         // 자연 은유
  | 'structural'      // 구조적 은유 (소설 구조 자체가 은유)
  | 'extended'        // 확장된 은유 (씬 전체에 걸친)
  | 'dead-to-alive';  // 죽은 은유를 살리기

// ============================================
// 문학적 깊이 엔진 클래스
// ============================================

export class LiteraryDepthEngine {

  /**
   * 마스터 문학 기법 가이드 생성
   * 씬 작성 프롬프트에 포함
   */
  generateMasterLiteraryGuide(sceneContext: {
    sceneNumber: number;
    sceneType: string;
    emotionalGoal: string;
    participants: string[];
    themes?: string[];
  }): string {
    let guide = `
---
## 문학적 깊이 마스터 가이드 (세계 최고 수준)

`;

    guide += this.generateMetaphorGuide(sceneContext.sceneType);
    guide += this.generateSymbolismGuide();
    guide += this.generateSubtextGuide(sceneContext.emotionalGoal);
    guide += this.generateIronyGuide(sceneContext.sceneType);
    guide += this.generateNarrativeDistanceGuide(sceneContext.sceneType);
    guide += this.generateTemporalTechniqueGuide(sceneContext.sceneType);
    guide += this.generateSilenceAndOmissionGuide();
    guide += this.generateMultiLayerMeaningGuide(sceneContext.themes);
    guide += this.generateMasterWriterTechniques();

    return guide;
  }

  // ============================================
  // 개별 기법 가이드
  // ============================================

  private generateMetaphorGuide(sceneType: string): string {
    return `
### 은유/비유 기법 (씬당 최소 3개)

#### 은유 품질 기준
- **1급 (최고)**: 두 영역의 예상치 못한 연결. 읽는 순간 "아!" 하는 깨달음
  * "그의 침묵은 상처 위의 딱지 같았다. 건드리면 다시 피가 날 것이다."
  * "대화가 얼음 위를 걷는 것 같았다. 한 발짝마다 갈라지는 소리가 났다."

- **2급 (좋음)**: 감각적이고 구체적. 추상적 개념을 신체적으로 표현
  * "죄책감이 어깨를 짓눌렀다"보다 → "어깨에 보이지 않는 돌이 얹혀 있었다. 걸을 때마다 무게가 늘었다."

- **금지 (진부한 은유)**:
  * "불같은 분노", "얼음처럼 차가운", "바다 같은 마음"
  * "어둠이 내려앉았다", "빛이 되어주다", "길을 잃었다"
  → 이미 닳은 은유. 독창적 연결을 만드세요.

#### 씬 타입별 은유 전략
${sceneType === 'climax' ? `- 클라이맥스: 강렬하고 짧은 은유. 신체적/운동감각적 은유 우선
  * "세상이 기울었다." "공기가 유리처럼 깨졌다."` :
      sceneType === 'important' ? `- 중요 씬: 확장된 은유 사용 가능. 하나의 은유를 씬 전체에 걸쳐 발전시키기
  * 예: "대화가 바둑 같았다" → 씬 내내 바둑 관련 어휘로 상황 묘사` :
        `- 일반 씬: 자연스럽게 녹아드는 일상적 은유. 과하지 않게.
  * 환경 묘사에 감정을 투영하는 방식 추천`}

#### 한국어 특화 은유 기법
- 한국 자연/계절을 활용한 은유 (사계절, 달, 바람, 물)
- 한국 전통 이미지 활용 (봇물, 서리, 안개, 산그림자)
- 소리의 은유: 한국어 의성어/의태어를 은유적으로 확장
  * "마음이 사각사각했다" "침묵이 똑똑 떨어졌다"
`;
  }

  private generateSymbolismGuide(): string {
    return `
### 상징 체계 운영

#### 상징 운영 원칙
1. **핵심 상징 3개 이하**: 과다하면 의미가 흐려짐
2. **진화하는 상징**: 같은 상징이 씬마다 다른 의미를 가지도록
   * 예: "칼" → 초반: 권력 → 중반: 폭력의 공포 → 후반: 선택/결단
3. **패서틱 팰러시**: 환경이 감정을 반영
   * 슬픈 장면 → 비 (너무 직접적) 대신 → 안개, 회색 하늘, 지는 꽃
   * 긴장 장면 → 폭풍 대신 → 불길한 고요, 이상한 동물 행동
4. **대비 상징**: 반대 의미의 상징을 나란히 배치
   * 빛과 어둠, 물과 불, 새장과 창

#### 자연 상징 활용
| 자연 요소 | 가능한 의미 |
|-----------|-------------|
| 물/강 | 시간의 흐름, 정화, 경계, 변화 |
| 불/화염 | 열정, 파괴, 정화, 분노 |
| 바람 | 변화, 자유, 불안정, 소식 |
| 달 | 변화(차고 기울기), 은밀함, 여성성 |
| 산 | 도전, 고독, 시련, 시야 |
| 새 | 자유, 영혼, 소식, 탈출 |
| 안개 | 불확실성, 은폐, 전환기 |
`;
  }

  private generateSubtextGuide(emotionalGoal: string): string {
    return `
### 서브텍스트 (말과 의미의 불일치)

#### 서브텍스트 원칙
"좋은 소설에서 캐릭터는 절대 자기 감정을 직접 말하지 않는다"

1. **대화의 빙산**: 대사의 10%만 드러나고 90%는 물 아래
   * "밥 먹었어?" → 실제 의미: "네가 걱정돼", "우리 사이 괜찮아?"
   * "바쁘다" → 실제 의미: "만나고 싶지 않아", "감당할 수 없어"

2. **행동과 대사의 모순** (가장 강력한 기법)
   * 입으로: "괜찮아" + 손은: 테이블 모서리를 꽉 쥐고 있다
   * 입으로: "너 없이도 잘 살아" + 눈은: 상대방의 빈 자리를 바라본다
   * 입으로: "상관없어" + 몸은: 한 발짝 물러선다

3. **대화 속 진짜 싸움**: 표면 주제 ≠ 진짜 주제
   * 표면: 저녁 메뉴를 정하는 대화
   * 진짜: 관계에서 누가 결정권을 가지는지에 대한 권력 싸움

4. **침묵의 서브텍스트**: 말하지 않는 것이 말하는 것보다 중요
   * "그는 아무 말도 하지 않았다. 다만 창밖을 바라보았다."
   * 답하지 않는 것 자체가 답

#### 현재 씬 적용: "${emotionalGoal}"
- 이 감정을 **절대 직접 말하지 마세요**
- 행동, 시선, 호흡, 손동작, 말투 변화로만 표현하세요
- 대화에서 다른 주제를 이야기하면서 이 감정이 스며나오도록 하세요
`;
  }

  private generateIronyGuide(sceneType: string): string {
    return `
### 아이러니 기법

#### 극적 아이러니 (독자 > 캐릭터)
독자는 알지만 캐릭터는 모르는 정보를 활용:
- 캐릭터가 "안전하다"고 믿는 순간, 독자는 위험을 알고 있음
- 캐릭터가 신뢰하는 사람이 배신자임을 독자만 알고 있음
- **효과**: 긴장감, 안타까움, 독자의 감정적 투자 증가

#### 상황적 아이러니 (기대와 결과의 불일치)
- 보호하려던 행동이 오히려 해를 끼침
- 피하려던 것이 정확히 현실이 됨
- 가장 약한 존재가 가장 결정적인 역할을 함

#### 언어적 아이러니 (반어법)
- 절대 과하지 않게. 한국어 문맥에서 자연스러운 수준으로.
- "참 잘됐군." (실제로는 최악의 상황에서)

${sceneType === 'climax'
      ? '#### 이 클라이맥스 씬: 극적 아이러니가 해소되는 순간을 만드세요.\n캐릭터가 마침내 독자가 알던 진실을 깨닫는 순간의 충격을 극대화하세요.'
      : '#### 이 씬: 극적 아이러니를 유지하거나 심화시키세요.\n독자가 캐릭터의 무지에 안타까워하거나 긴장하도록.'}
`;
  }

  private generateNarrativeDistanceGuide(sceneType: string): string {
    return `
### 서술 거리 조절 (카메라 기법)

서술의 "카메라"를 의도적으로 조절하세요:

#### 클로즈업 (가장 가까운 거리)
- 내면 독백, 감각의 디테일, 미세한 표정 변화
- 사용 시점: 감정적 절정, 중요한 깨달음, 친밀한 순간
- "그의 눈동자에 비친 자신의 얼굴이 일그러져 있었다."

#### 미디엄 샷 (중간 거리)
- 대화와 행동, 공간과 인물의 관계
- 사용 시점: 대부분의 씬, 대화 장면
- "두 사람은 마주 앉았다. 테이블 위의 찻잔에서 김이 올랐다."

#### 롱 샷 (먼 거리)
- 풍경, 전체 상황, 시간의 흐름
- 사용 시점: 씬 오프닝, 시간 경과, 규모감 표현
- "성벽 위에 선 작은 인영이 보였다. 저 아래로 만 명의 군사가 펼쳐져 있었다."

#### ${sceneType === 'climax' ? '클라이맥스: 클로즈업과 롱 샷을 급격히 교차하세요. 내면의 감정과 외부의 거대한 상황을 번갈아 보여주는 것이 가장 강렬합니다.' :
      sceneType === 'important' ? '중요 씬: 미디엄에서 시작하여 핵심 순간에 클로즈업으로 전환하세요.' :
        '일반 씬: 롱 샷으로 공간을 잡고 미디엄으로 전환하세요.'}
`;
  }

  private generateTemporalTechniqueGuide(sceneType: string): string {
    return `
### 시간 조작 기법

#### 1. 슬로우 모션 (시간 늘리기)
결정적 순간을 초 단위로 늘려서 묘사:
- 일반 속도: "칼이 날아왔고 그가 피했다"
- 슬로우모션: "칼날이 번뜩였다. 공기가 갈라지는 소리가 들렸다. 그의 눈에 자신의 얼굴이 비쳤다. 몸이 반응했다. 근육이 수축하고, 무릎이 꺾이고, 세상이 기울었다. 칼날이 머리카락 한 올을 베며 지나갔다."
- **사용 시점**: 전투, 사고, 깨달음의 순간

#### 2. 타임 스킵 (시간 건너뛰기)
중요하지 않은 시간을 우아하게 건너뛰기:
- "사흘이 지났다." → 너무 직접적
- "셋째 날 아침, 그의 수염이 거칠어져 있었다." → 신체 변화로 시간 경과 표현
- "눈이 내리고, 녹고, 또 내렸다." → 반복으로 시간 경과

#### 3. 플래시백/플래시포워드
- 플래시백: 현재 감각이 과거 기억을 촉발하도록 (냄새, 소리, 촉감)
  * ❌ "그때가 떠올랐다. 10년 전..."
  * ✅ "낡은 나무 냄새가 코끝을 스쳤다. 손끝에 남아 있던 감촉—" (자연스럽게 과거로)
- 플래시포워드: 극히 드물게, 불길한 예감으로만

#### 4. 반복 (시간의 원환)
- 비슷한 상황이 다른 맥락에서 반복되어 의미가 변화
- 처음에는 평범했던 행동이 나중에는 전혀 다른 의미를 가지도록
`;
  }

  private generateSilenceAndOmissionGuide(): string {
    return `
### 여백과 생략의 기법 (빙산 이론)

"헤밍웨이의 빙산 이론: 보이는 것은 1/8, 나머지 7/8은 물 아래에 있어야 한다"

#### 1. 전략적 생략
- 모든 것을 설명하지 마세요. 독자가 채울 공간을 남기세요.
- 가장 강렬한 순간은 직접 묘사하지 않고 전후만 보여주기
  * 전투의 결과: 전투 장면 대신 전투 후의 정적과 상처
  * 고백: 말하는 순간 대신 말한 후의 침묵
  * 죽음: 죽는 순간 대신 빈 방, 남겨진 물건

#### 2. 행간 (줄 사이의 의미)
- 문단 사이의 빈 줄 = 시간/감정의 간격
- 짧은 문단 = 여운, 강조, 전환
- 대사 후 묘사 없이 다음 대사 = 팽팽한 긴장

#### 3. 엔딩의 여백
- 모든 것을 해결하지 마세요
- 독자가 마지막 페이지를 넘긴 후에도 생각하도록
- 열린 결말의 힘: 답 대신 더 깊은 질문을 남기세요
`;
  }

  private generateMultiLayerMeaningGuide(themes?: string[]): string {
    return `
### 다층적 의미 구조

#### 3개 층위로 쓰기
모든 씬은 최소 3개 층위의 의미를 가져야 합니다:

1. **표면 층 (Plot)**: 무슨 일이 일어나는가
   - 누가 무엇을 하고, 무슨 말을 하는가
   - 독자 100%가 이해

2. **감정 층 (Character)**: 캐릭터가 진짜 느끼는 것
   - 행동과 대사 아래의 진짜 감정
   - 서브텍스트를 읽는 독자 70%가 이해

3. **주제 층 (Theme)**: 이 씬이 말하려는 더 큰 이야기
   - 인간, 사회, 존재에 대한 보편적 진실
   - 깊이 읽는 독자 30%가 이해
${themes && themes.length > 0 ? `\n   - 현재 주제: ${themes.join(', ')}` : ''}

#### 예시
> 표면: 두 사람이 바둑을 둔다
> 감정: 아버지가 아들에게 자신의 방식을 가르치려 하지만, 아들은 자신만의 길을 가고 싶다
> 주제: 전통과 혁신의 갈등, 세대 간의 단절과 연결

**모든 씬에서 이 3층위를 의식하며 쓰세요.**
`;
  }

  private generateMasterWriterTechniques(): string {
    return `
### 거장 작가들의 핵심 기법

#### 1. 안톤 체호프 - "보여주기의 달인"
- 감정을 환경/사물로 표현
- "한 번도 등장인물의 감정을 설명하지 않았다. 다만 그들의 행동을 보여주었다."
- 기법: 사소한 디테일에 거대한 감정을 담기

#### 2. 어니스트 헤밍웨이 - "빙산 이론"
- 문장을 최대한 간결하게
- 생략이 말보다 강하다
- 기법: 가장 중요한 것을 말하지 않기

#### 3. 가브리엘 가르시아 마르케스 - "마술적 리얼리즘"
- 경이로운 것을 당연하게 서술
- 일상적인 것을 경이롭게 서술
- 기법: 톤의 반전 (심각한 상황을 담담하게, 사소한 것을 극적으로)

#### 4. 무라카미 하루키 - "일상과 비일상의 경계"
- 구체적인 고유명사/브랜드명 사용으로 현실감
- 비유에 일상적 이미지 사용 (직접적이지만 신선한)
- 기법: 초현실적 요소를 자연스러운 문체로

#### 5. 이문열/박경리 - "한국 문학의 정수"
- 계절감과 자연의 변화로 시간과 감정 표현
- 인물의 내면을 행동/관계의 변화로 보여주기
- 한국어 고유의 리듬감 활용 (3-4음절 리듬, 대구, 점층)
- 기법: 한국적 정서(한, 정, 흥)를 보편적 감정으로 승화

#### 적용 원칙
- 위 거장들의 기법을 **의식적으로** 1씬에 2개 이상 적용하세요
- 단, 기법이 드러나면 실패. 자연스러워야 합니다.
- "좋은 글쓰기는 보이지 않는 글쓰기다"
`;
  }
}

export default LiteraryDepthEngine;
