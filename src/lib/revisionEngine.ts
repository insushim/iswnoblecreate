/**
 * 퇴고 시스템 (RevisionEngine) v1.0
 *
 * AI가 생성한 텍스트를 다중 패스로 퇴고하는 시스템
 * - 1차: 문장 수준 교정 (클리셰, 반복, 설명적 서술)
 * - 2차: 구조 수준 교정 (페이싱, 긴장감, 장면 전환)
 * - 3차: 문학적 깊이 강화 (은유, 서브텍스트, 감각 묘사)
 * - 4차: 캐릭터 음성 일관성 검증 (대사/내면 톤 통일)
 * - 5차: 최종 다듬기 (리듬, 첫/끝 문장, 여백)
 */

// ============================================
// 퇴고 패스 정의
// ============================================

export interface RevisionPass {
  name: string;
  order: number;
  focus: RevisionFocus;
  instructions: string;
  checkpoints: string[];
}

export type RevisionFocus =
  | 'sentence-level'      // 문장 수준
  | 'structure-level'     // 구조 수준
  | 'literary-depth'      // 문학적 깊이
  | 'character-voice'     // 캐릭터 음성
  | 'final-polish';       // 최종 다듬기

export interface RevisionResult {
  passName: string;
  issues: RevisionIssue[];
  suggestions: string[];
  overallScore: number;  // 0-100
}

export interface RevisionIssue {
  type: RevisionIssueType;
  severity: 'critical' | 'major' | 'minor' | 'suggestion';
  location: string;       // 대략적 위치 설명
  description: string;    // 문제 설명
  fix: string;            // 수정 방법
  example?: string;       // 수정 예시
}

export type RevisionIssueType =
  | 'cliche'              // 클리셰
  | 'repetition'          // 반복 표현
  | 'telling-not-showing' // 설명적 서술
  | 'weak-verb'           // 약한 동사
  | 'adverb-overuse'      // 부사 남용
  | 'info-dump'           // 정보 과다 투입
  | 'pacing'              // 페이싱 문제
  | 'flat-dialogue'       // 평면적 대사
  | 'missing-sensory'     // 감각 묘사 부족
  | 'weak-transition'     // 약한 장면 전환
  | 'voice-inconsistency' // 음성 불일치
  | 'subtext-missing'     // 서브텍스트 부재
  | 'rhythm-issue'        // 리듬 문제
  | 'weak-opening'        // 약한 시작
  | 'weak-ending'         // 약한 끝
  | 'filter-words'        // 필터 단어 (느꼈다, 생각했다)
  | 'passive-voice'       // 피동태 남용
  | 'emotional-jump'      // 감정 비약
  | 'purple-prose'        // 과잉 묘사
  | 'redundancy';         // 중복 서술

// ============================================
// 퇴고 엔진 클래스
// ============================================

export class RevisionEngine {
  private passes: RevisionPass[];

  constructor() {
    this.passes = this.initializePasses();
  }

  /**
   * 5단계 퇴고 프롬프트 생성
   * 씬 작성 후 AI에게 퇴고를 지시하는 프롬프트
   */
  generateRevisionPrompt(sceneText: string, sceneContext: {
    sceneType: string;
    emotionalGoal: string;
    participants: string[];
    sceneNumber: number;
  }): string {
    return `
## 퇴고 시스템 - 5단계 자기 검토

당신이 방금 작성한 텍스트를 아래 5단계에 따라 퇴고하세요.
퇴고 후 최종 수정된 텍스트만 출력하세요. 퇴고 과정은 출력하지 마세요.

---

### 1단계: 문장 수준 교정
${this.passes[0].instructions}

**체크리스트:**
${this.passes[0].checkpoints.map(c => `- [ ] ${c}`).join('\n')}

---

### 2단계: 구조 수준 교정
${this.passes[1].instructions}

**체크리스트:**
${this.passes[1].checkpoints.map(c => `- [ ] ${c}`).join('\n')}

---

### 3단계: 문학적 깊이 강화
${this.passes[2].instructions}

**체크리스트:**
${this.passes[2].checkpoints.map(c => `- [ ] ${c}`).join('\n')}

---

### 4단계: 캐릭터 음성 검증
${this.passes[3].instructions}

**참여 캐릭터:** ${sceneContext.participants.join(', ')}
**체크리스트:**
${this.passes[3].checkpoints.map(c => `- [ ] ${c}`).join('\n')}

---

### 5단계: 최종 다듬기
${this.passes[4].instructions}

**씬 타입:** ${sceneContext.sceneType}
**감정 목표:** ${sceneContext.emotionalGoal}
**체크리스트:**
${this.passes[4].checkpoints.map(c => `- [ ] ${c}`).join('\n')}

---

**최종 출력 규칙:**
- 퇴고 과정, 메모, 체크리스트 결과를 절대 출력하지 마세요
- 오직 수정 완료된 소설 본문만 출력하세요
- 분량은 원본과 동일하게 유지하세요 (줄이지 마세요)
`;
  }

  /**
   * 씬 작성 프롬프트에 포함할 자체 퇴고 지침
   * (별도 API 호출 없이, 작성 시 자체 검토하도록)
   */
  generateInlineRevisionGuide(): string {
    return `
---
## 퇴고 내장 지침 (작성하면서 적용)

### 문장 검수 규칙
1. **필터 단어 제거**: "느꼈다", "생각했다", "보였다", "들렸다", "~인 것 같았다" 삭제
   - ❌ "그는 두려움을 느꼈다" → ✅ "손끝이 떨렸다. 입안이 바짝 말랐다."
   - ❌ "아름다운 풍경이 보였다" → ✅ "산봉우리 너머로 붉은 노을이 번졌다"

2. **약한 동사 강화**: "있다", "했다", "되다" → 구체적 동사
   - ❌ "방에 있었다" → ✅ "방 한켠에 웅크리고 있었다"
   - ❌ "걸어갔다" → ✅ "성큼성큼 다가갔다" / "비틀거리며 나아갔다"

3. **부사 남용 금지**: 부사 대신 강한 동사/구체적 묘사
   - ❌ "빠르게 달렸다" → ✅ "질주했다" / "발바닥이 지면을 박차며 내달렸다"
   - ❌ "매우 화가 났다" → ✅ "이가 갈렸다. 주먹이 하얗게 질렸다."

4. **클리셰 금지 목록**:
   - "눈물이 뚝뚝", "가슴이 먹먹", "심장이 쿵쾅", "머리가 하얘졌다"
   - "어둠이 내려앉았다", "시간이 멈춘 것 같았다", "벼락같은 소리"
   - "전율이 흘렀다", "온몸에 소름이", "눈앞이 캄캄해졌다"
   → 독창적 표현으로 대체하세요

5. **반복 표현 감지**: 같은 단어/구문이 3문장 이내에 재등장하면 대체어 사용

6. **피동태 → 능동태**: "~되었다", "~당했다" 최소화

### 구조 검수 규칙
1. **첫 문장**: 독자를 즉시 끌어들이는 강렬한 시작 (상황/감각/행동 중 하나)
2. **마지막 문장**: 여운 또는 다음 씬 궁금증 유발
3. **정보 과부하 금지**: 배경설명은 행동/대화 사이에 1-2문장씩만
4. **장면 전환**: 시간/공간 변화 시 감각 묘사로 자연스럽게
5. **페이싱**: 긴장 고조 → 짧은 문장, 여유 장면 → 긴 문장

### 깊이 검수 규칙
1. **매 페이지**: 최소 하나의 감각 묘사 (시각 외)
2. **대화 장면**: 서브텍스트 포함 (말과 진심의 불일치)
3. **감정 표현**: 신체 반응으로만 (직접 감정 명명 금지)
4. **상징/모티프**: 씬의 분위기와 어울리는 환경 묘사 배치
`;
  }

  /**
   * 별도 퇴고 API 호출용 프롬프트 (2차 패스)
   */
  generateSecondPassPrompt(originalText: string, sceneContext: {
    sceneType: string;
    emotionalGoal: string;
    participants: string[];
  }): string {
    return `당신은 한국 문학계 최고의 편집자입니다.
아래 소설 텍스트를 출판 가능한 수준으로 퇴고하세요.

## 퇴고 규칙

### 절대 금지 (발견 즉시 수정)
- "느꼈다", "생각했다", "보였다" 등 필터 단어
- "~인 것 같았다", "~라고 할 수 있었다" 우회적 서술
- 동일 단어/표현 3문장 이내 반복
- 감정 직접 명명 ("슬펐다", "화가 났다")
- 클리셰 표현 (목록은 아래 참조)
- "있었다", "했다", "되었다" 연속 사용
- 부사 남용 ("매우", "정말", "아주", "완전히")

### 반드시 강화
- 감각 묘사: 매 단락마다 시각 외 1개 이상 감각
- 신체 언어: 감정을 행동/신체반응으로 표현
- 서브텍스트: 대화에서 말과 진심의 괴리
- 문장 리듬: 긴장 시 짧게, 여유 시 길게
- 환경 묘사: 감정을 반영하는 날씨/공간/빛

### 씬 정보
- 씬 타입: ${sceneContext.sceneType}
- 감정 목표: ${sceneContext.emotionalGoal}
- 참여 캐릭터: ${sceneContext.participants.join(', ')}

### 출력 규칙
- 수정된 소설 본문만 출력
- 분량은 원본과 동일하게 유지 (절대 줄이지 마세요)
- 퇴고 과정/메모 출력 금지
- 스토리 내용은 변경하지 마세요 (문장/표현만 개선)

---

## 원본 텍스트

${originalText}

---

위 텍스트를 퇴고한 최종 버전을 출력하세요.`;
  }

  // ============================================
  // Private: 패스 초기화
  // ============================================

  private initializePasses(): RevisionPass[] {
    return [
      {
        name: '문장 수준 교정',
        order: 1,
        focus: 'sentence-level',
        instructions: `모든 문장을 하나씩 점검하세요:
- "느꼈다/생각했다/보였다" 등 필터 단어를 삭제하고 직접 묘사로 교체
- "있었다/했다/되었다"가 3연속 나오면 동사 변형
- 부사("매우/정말/아주")를 강한 동사로 교체
- 피동태("~되었다/~당했다")를 능동태로 전환
- 동일 어미(-다/-ㄴ다/-였다)가 4문장 연속되지 않도록 변형
- 감정 명명("슬펐다/화가 났다/두려웠다")을 신체 반응으로 교체`,
        checkpoints: [
          '필터 단어(느꼈다/생각했다/보였다) 0개인가?',
          '같은 단어가 3문장 이내 반복되지 않는가?',
          '감정을 직접 명명한 곳이 없는가?',
          '부사 사용이 페이지당 2개 이하인가?',
          '피동태가 전체의 10% 이하인가?',
        ],
      },
      {
        name: '구조 수준 교정',
        order: 2,
        focus: 'structure-level',
        instructions: `전체 구조를 점검하세요:
- 첫 문장: 감각/행동/대화로 시작하는지 (배경설명 시작 금지)
- 마지막 문장: 여운 또는 궁금증을 남기는지
- 정보 과다: 3문장 이상 연속 설명이 없는지 (행동 사이에 끼워넣기)
- 페이싱: 긴장 장면은 짧은 문장, 성찰 장면은 긴 문장
- 장면 내 전환: 시간/공간 이동 시 감각 앵커 사용
- 대화 비율: 대사만 연속 5줄 넘지 않도록 행동/묘사 삽입`,
        checkpoints: [
          '첫 문장이 감각/행동/대화 중 하나로 시작하는가?',
          '마지막 문장이 여운을 남기는가?',
          '3문장 이상 연속 설명 블록이 없는가?',
          '대화만 5줄 연속 나오는 곳이 없는가?',
          '긴장 장면에서 문장이 짧아지는가?',
        ],
      },
      {
        name: '문학적 깊이 강화',
        order: 3,
        focus: 'literary-depth',
        instructions: `문학적 품질을 높이세요:
- 감각 묘사: 시각 외에 청각/촉각/후각/미각 중 2개 이상 추가
- 은유/비유: 진부하지 않은 독창적 비유 1씬당 최소 2개
- 상징: 환경(날씨/빛/공간)이 인물의 심리를 반영하도록
- 서브텍스트: 중요 대화에서 말의 표면과 진심이 다르도록
- 극적 아이러니: 독자가 캐릭터보다 더 많이/적게 아는 상황 활용
- 여백: 모든 것을 설명하지 말고, 독자가 채울 공간 남기기`,
        checkpoints: [
          '시각 외 감각 묘사가 2종류 이상 있는가?',
          '독창적 비유/은유가 2개 이상 있는가?',
          '환경이 심리를 반영하고 있는가?',
          '서브텍스트가 있는 대화가 존재하는가?',
          '독자가 해석할 여백이 있는가?',
        ],
      },
      {
        name: '캐릭터 음성 검증',
        order: 4,
        focus: 'character-voice',
        instructions: `캐릭터별 음성을 검증하세요:
- 각 캐릭터의 대사가 말투/어휘/리듬에서 구별되는지
- 서술태그("~라고 말했다")가 반복되지 않는지
- 대사 없이 행동만으로도 누구인지 알 수 있는지
- 캐릭터의 감정 상태가 대사 톤에 반영되는지
- 내면 독백의 어조가 대사와 일관되는지
- 호칭이 관계에 맞는지`,
        checkpoints: [
          '대사만 봐도 누구인지 구별 가능한가?',
          '"~라고 말했다" 서술태그가 3회 이상 반복되지 않는가?',
          '캐릭터마다 고유한 언어적 특징이 있는가?',
          '감정 변화가 말투에 반영되는가?',
          '호칭이 관계에 적절한가?',
        ],
      },
      {
        name: '최종 다듬기',
        order: 5,
        focus: 'final-polish',
        instructions: `최종 품질을 확인하세요:
- 문장 리듬: 소리 내어 읽었을 때 자연스러운지
- 단어 선택: 더 정확하고 아름다운 단어가 없는지
- 문단 길이: 너무 긴 문단(10줄 이상) 분리
- 시제 일관성: 과거형/현재형 혼용 없는지
- 첫 문장 재검토: 정말 이 시작이 최선인가?
- 마지막 문장 재검토: 독자가 다음 씬을 넘기고 싶어지는가?
- 불필요한 문장 삭제: 빼도 의미가 통하면 삭제
- 여운과 울림: 읽고 나서 마음에 남는 것이 있는가?`,
        checkpoints: [
          '소리 내어 읽었을 때 자연스러운가?',
          '불필요한 문장이 없는가?',
          '시제가 일관적인가?',
          '문단 길이가 적절한가?',
          '첫/끝 문장이 강렬한가?',
          '읽고 난 뒤 여운이 남는가?',
        ],
      },
    ];
  }
}

// ============================================
// 클리셰 데이터베이스
// ============================================

export const KOREAN_CLICHES: { cliche: string; alternatives: string[] }[] = [
  {
    cliche: '눈물이 뚝뚝 떨어졌다',
    alternatives: ['시야가 흐려졌다', '뺨 위로 뜨거운 것이 흘러내렸다', '목구멍이 타들어갔다'],
  },
  {
    cliche: '가슴이 먹먹해졌다',
    alternatives: ['명치 아래가 돌덩이처럼 무거웠다', '숨이 턱 막혔다', '갈비뼈 사이가 쑤셨다'],
  },
  {
    cliche: '심장이 쿵쾅거렸다',
    alternatives: ['맥박이 귀 뒤에서 울렸다', '가슴팍이 요동쳤다', '심장이 목구멍까지 치밀었다'],
  },
  {
    cliche: '머리가 하얘졌다',
    alternatives: ['생각의 실이 끊어졌다', '뇌가 텅 빈 것 같았다', '모든 소리가 멀어졌다'],
  },
  {
    cliche: '시간이 멈춘 것 같았다',
    alternatives: ['세상이 느려졌다', '공기가 응고됐다', '찰나가 영원처럼 늘어졌다'],
  },
  {
    cliche: '온몸에 소름이 돋았다',
    alternatives: ['팔뚝의 잔털이 곤두섰다', '등골을 따라 차가운 것이 흘렀다', '피부가 쪼그라드는 느낌이었다'],
  },
  {
    cliche: '눈앞이 캄캄해졌다',
    alternatives: ['시야 가장자리가 어두워졌다', '세상이 기울어지는 느낌이었다', '빛이 사라져갔다'],
  },
  {
    cliche: '전율이 흘렀다',
    alternatives: ['척추를 타고 무언가가 스며들었다', '뼛속까지 서늘해졌다', '살갗이 떨렸다'],
  },
  {
    cliche: '어둠이 내려앉았다',
    alternatives: ['그림자가 방을 삼켰다', '빛이 한 올씩 빠져나갔다', '공간이 무거워졌다'],
  },
  {
    cliche: '벼락같은 소리',
    alternatives: ['공기를 찢는 소리', '고막을 때리는 굉음', '뼈를 울리는 울림'],
  },
  {
    cliche: '피가 끓었다',
    alternatives: ['관자놀이가 뜨거워졌다', '핏줄이 팽팽하게 당겨졌다', '혈관 속에서 뭔가가 들끓었다'],
  },
  {
    cliche: '입술을 깨물었다',
    alternatives: ['이를 악물었다', '턱에 힘이 들어갔다', '입안이 쓴맛으로 가득 찼다'],
  },
];

/**
 * 필터 단어 목록 (사용 금지)
 */
export const FILTER_WORDS = [
  '느꼈다', '느낀다', '느껴졌다',
  '생각했다', '생각한다', '생각이 들었다',
  '보였다', '보인다', '보이는',
  '들렸다', '들린다', '들리는',
  '~인 것 같았다', '것 같았다', '듯했다',
  '~라고 할 수 있었다',
  '알 수 있었다',
  '분명했다', '분명히',
  '당연히', '물론',
];

/**
 * 약한 동사 목록 (대체 권장)
 */
export const WEAK_VERBS = [
  { weak: '있었다', context: '장소', alternatives: ['서 있었다', '웅크리고 있었다', '자리하고 있었다'] },
  { weak: '갔다', context: '이동', alternatives: ['발걸음을 옮겼다', '나아갔다', '향했다'] },
  { weak: '왔다', context: '도착', alternatives: ['나타났다', '모습을 드러냈다', '다가왔다'] },
  { weak: '했다', context: '행동', alternatives: ['구체적 동사로 교체'] },
  { weak: '말했다', context: '대화', alternatives: ['속삭였다', '내뱉었다', '중얼거렸다', '소리쳤다'] },
];

export default RevisionEngine;
