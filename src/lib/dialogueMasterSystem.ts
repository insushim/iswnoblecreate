/**
 * 대화 마스터 시스템 (DialogueMasterSystem) v1.0
 *
 * 출판 수준의 서브텍스트 있는 대화 작성을 위한 시스템
 * - 대화의 3층 구조 (표면/감정/주제)
 * - 서브텍스트 패턴 라이브러리
 * - 대화 리듬과 페이싱
 * - 서술태그 다양화
 * - 침묵과 비언어적 커뮤니케이션
 * - 갈등 대화 기법
 * - 한국어 대화체 특화
 */

// ============================================
// 대화 품질 타입 정의
// ============================================

export interface DialogueDesign {
  surfaceTopic: string;         // 표면적 대화 주제
  realConflict: string;         // 진짜 갈등/갈등
  emotionalUndercurrent: string; // 감정적 저류
  powerDynamic: string;         // 힘의 역학 (누가 우위)
  turnPattern: string;          // 대화 전환 패턴
  resolution: 'resolved' | 'escalated' | 'interrupted' | 'deferred';
}

export type DialogueFunction =
  | 'reveal-character'     // 캐릭터 성격 드러내기
  | 'advance-plot'         // 플롯 진전
  | 'build-tension'        // 긴장 고조
  | 'expose-conflict'      // 갈등 드러내기
  | 'deliver-information'  // 정보 전달
  | 'show-relationship'    // 관계 보여주기
  | 'comic-relief'         // 긴장 완화
  | 'foreshadow'           // 복선
  | 'thematic'             // 주제 표현
  | 'emotional-turning';   // 감정적 전환점

// ============================================
// 대화 마스터 시스템 클래스
// ============================================

export class DialogueMasterSystem {

  /**
   * 씬 대화 가이드 생성
   */
  generateDialogueGuide(sceneContext: {
    participants: string[];
    emotionalGoal: string;
    sceneType: string;
    hasConflict: boolean;
  }): string {
    return `
---
## 대화 마스터 가이드 (출판 수준)

### 대화의 3층 구조 (모든 중요 대화에 적용)

**모든 의미 있는 대화는 3개 층을 가져야 합니다:**

1. **표면 층**: 실제로 말하는 내용
   - "날씨가 좋네."

2. **감정 층**: 진짜 느끼는 것 (서브텍스트)
   - (너와 이렇게 있는 게 좋다)

3. **주제 층**: 이 대화가 소설 전체에서 의미하는 것
   - (소통의 어려움 / 말과 마음의 거리)

### 서브텍스트 핵심 기법

#### 1. 간접 대화 (가장 중요!)
캐릭터는 절대 자기 감정을 직접 말하지 않습니다.

❌ 직접적 (아마추어):
"나 너무 화가 나."
"네가 미워."
"사실 너를 좋아해."
"나는 두려워."

✅ 간접적 (프로):
"밥 먹었어?" → (네가 걱정돼)
"별일 없지?" → (무슨 일이 있다는 걸 알지만 직접 묻기 두려워)
"시간 됐네." → (더 있고 싶지만 이유를 말할 수 없어)
"그래, 가." → (가지 마)

#### 2. 행동과 대사의 모순
말하는 내용과 행동이 반대:
- "괜찮아." + 손이 떨린다
- "상관없어." + 상대방을 계속 훔쳐본다
- "알아서 해." + 문을 세게 닫는다
- "잘 가." + 발걸음을 떼지 못한다

#### 3. 대답하지 않기
가장 강력한 서브텍스트:
- 질문에 다른 주제로 넘어가기 → 회피
- 침묵 → 긍정 또는 말할 수 없는 상황
- 되묻기 → 방어
- 웃음 → 진심을 숨김

### 대화 리듬과 페이싱

#### 긴장 대화 (짧고 빠르게)
\`\`\`
"왜 왔어."
"너를 보려고."
"..."
"진짜야."
"돌아가."
\`\`\`

#### 감정 대화 (길고 끊기면서)
\`\`\`
"그때... 내가 왜 그랬는지 알아?"
긴 침묵이 흘렀다.
"..."
"아직도 그 얘기를 해야 하나."
그의 목소리가 흔들렸다. 아주 미세하게.
\`\`\`

#### 정보 대화 (자연스럽게 끼워넣기)
\`\`\`
❌ "이 마을은 300년 역사를 가진 곳으로..."
✅ "할아버지도, 할아버지의 할아버지도 여기서 태어났다고 했지."
\`\`\`

### 서술태그 다양화 (매우 중요!)

#### 금지: "~라고 말했다" 연속 사용 (3회 이상 연속 절대 금지)

#### 대체 패턴 (교대 사용):
| 패턴 | 예시 |
|------|------|
| **행동 + 대사** | 검을 뽑았다. "지금이다." |
| **대사만** | "그럴 수는 없어." (문맥으로 화자 구분) |
| **반응 + 대사** | 눈이 커졌다. "정말?" |
| **대사 + 내면** | "그래." 하지만 속으로는 달랐다. |
| **환경 + 대사** | 바람이 불었다. "떠나자." |
| **대사 + 행동** | "기다려." 그가 손을 뻗었다. |
| **감각 + 대사** | 목구멍이 타들어갔다. "물... 물 좀." |
| **침묵 서술** | 아무 말도 하지 않았다. 다만 고개를 돌렸다. |

### 갈등 대화 기법

${sceneContext.hasConflict ? `
**이 씬에 갈등이 있습니다. 다음 기법을 적용하세요:**

1. **에스컬레이션**: 대화가 점점 격해지도록
   - 존댓말 → 반말 전환
   - 문장이 점점 짧아짐
   - 목소리가 점점 커짐 (직접 "소리쳤다" 대신 행동으로)

2. **언더컷**: 긴장이 최고조일 때 예상과 다른 반응
   - 화가 최고조 → 갑자기 웃음 (더 무섭다)
   - 대판 싸움 직전 → 조용히 돌아서기 (더 아프다)

3. **비대칭**: 한 쪽은 격앙, 다른 쪽은 침착
   - 더 침착한 쪽이 더 무섭도록
   - 또는 더 아프도록
` : `
**이 씬은 직접적 갈등이 없지만, 잠재적 긴장감은 있어야 합니다:**
- 표면적으로 평화로운 대화 아래 미묘한 불협화음
- 동의하면서도 살짝 다른 뉘앙스
- 말하지 않는 것에 주목
`}

### 한국어 대화체 특화

#### 존비어 체계 활용
- 관계 변화를 존비어 변화로 표현
  * 존경 → 친밀: 높임말 → 반말 전환의 순간
  * 거리감: 갑자기 높임말로 돌아가기 ("하지 마세요" - 냉랭함 표현)
  * 분노: 높임말인데 날카로운 어조 (더 무섭다)

#### 한국어 특유의 대화 기법
- 끝말 흐리기: "그건..." "사실은..." (말을 못 잇는 것)
- 되묻기: "그래서?" "뭐?" (방어 기제)
- 한숨/비언어: "..." 다음 행동 묘사
- 간접 화법: "~라고 했다" 대신 "~란다" "~래" (구어체)

### 참여 캐릭터: ${sceneContext.participants.join(', ')}
- 각 캐릭터의 대사가 고유한 말투/어휘/리듬을 가지도록
- 대사만 읽어도 누구인지 알 수 있어야 합니다
`;
  }

  /**
   * 대화 검증 프롬프트 (퇴고 시 사용)
   */
  generateDialogueValidationPrompt(dialogueText: string): string {
    return `## 대화 품질 검증

아래 대화를 분석하세요:

### 검증 항목:
1. "~라고 말했다" 서술태그가 3회 이상 연속되는 곳이 있는가?
2. 캐릭터가 자기 감정을 직접 말하는 곳이 있는가?
3. 서브텍스트가 있는 대화가 1개 이상 있는가?
4. 대사만 읽어도 화자를 구별할 수 있는가?
5. 정보 전달이 자연스러운가? (강의식 설명 없는가?)
6. 대화의 리듬이 장면 분위기에 맞는가?

### 대화 텍스트:
${dialogueText}

### JSON 응답:
{
  "tagRepetitions": number,
  "directEmotionCount": number,
  "subtextPresent": boolean,
  "characterDistinguishable": boolean,
  "infoDumpCount": number,
  "rhythmMatch": boolean,
  "issues": [...],
  "improvements": [...]
}`;
  }
}

export default DialogueMasterSystem;
